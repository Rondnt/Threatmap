import { useState, useEffect } from 'react';
import { toast } from 'react-toastify';

const VulnerabilityForm = ({ vulnerability, onSubmit, onCancel }) => {
  // Get local date in YYYY-MM-DD format
  const getLocalDate = () => {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
  };

  const [formData, setFormData] = useState({
    name: '',
    description: '',
    cvss_score: 5.0,
    severity: 'medium',
    affected_system: '',
    cve_id: '',
    discovery_date: getLocalDate(),
    status: 'open'
  });

  useEffect(() => {
    if (vulnerability) {
      // Manejar affected_systems (puede venir como array o string)
      let affectedSystemValue = '';
      if (vulnerability.affected_systems) {
        affectedSystemValue = Array.isArray(vulnerability.affected_systems)
          ? vulnerability.affected_systems.join(', ')
          : vulnerability.affected_systems;
      } else if (vulnerability.affected_system) {
        affectedSystemValue = vulnerability.affected_system;
      }

      setFormData({
        name: vulnerability.name || '',
        description: vulnerability.description || '',
        cvss_score: vulnerability.cvss_score || 5.0,
        severity: vulnerability.severity || 'medium',
        affected_system: affectedSystemValue,
        cve_id: vulnerability.cve_id || '',
        discovery_date: vulnerability.discovered_at
          ? new Date(vulnerability.discovered_at).toISOString().split('T')[0]
          : (vulnerability.discovery_date
            ? new Date(vulnerability.discovery_date).toISOString().split('T')[0]
            : getLocalDate()),
        status: vulnerability.status || 'open'
      });
    }
  }, [vulnerability]);

  const handleChange = (e) => {
    const { name, value } = e.target;

    // Auto-determinar severidad basada en CVSS
    if (name === 'cvss_score') {
      const score = parseFloat(value) || 0;
      let severity = 'low';
      if (score >= 9.0) severity = 'critical';
      else if (score >= 7.0) severity = 'high';
      else if (score >= 4.0) severity = 'medium';

      setFormData(prev => ({
        ...prev,
        cvss_score: score,
        severity
      }));
    } else {
      setFormData(prev => ({
        ...prev,
        [name]: value
      }));
    }
  };

  const handleSubmit = (e) => {
    e.preventDefault();

    // Validaciones
    if (!formData.name.trim()) {
      toast.error('El nombre es requerido');
      return;
    }

    if (formData.cvss_score < 0 || formData.cvss_score > 10) {
      toast.error('El CVSS Score debe estar entre 0 y 10');
      return;
    }

    onSubmit(formData);
  };

  const getSeverityColor = (severity) => {
    const colors = {
      critical: 'text-red-600',
      high: 'text-orange-600',
      medium: 'text-yellow-600',
      low: 'text-green-600'
    };
    return colors[severity] || 'text-gray-600';
  };

  const getSeverityText = (severity) => {
    const texts = {
      critical: 'Crítica',
      high: 'Alta',
      medium: 'Media',
      low: 'Baja'
    };
    return texts[severity] || severity;
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-4">
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {/* Nombre */}
        <div className="md:col-span-2">
          <label className="block text-sm font-medium text-gray-700 mb-1">
            Nombre de la Vulnerabilidad *
          </label>
          <input
            type="text"
            name="name"
            value={formData.name}
            onChange={handleChange}
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
            placeholder="Ej: SQL Injection en formulario de login"
            required
          />
        </div>

        {/* Descripción */}
        <div className="md:col-span-2">
          <label className="block text-sm font-medium text-gray-700 mb-1">
            Descripción
          </label>
          <textarea
            name="description"
            value={formData.description}
            onChange={handleChange}
            rows="3"
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
            placeholder="Describe la vulnerabilidad encontrada..."
          />
        </div>

        {/* CVE ID */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            CVE ID
          </label>
          <input
            type="text"
            name="cve_id"
            value={formData.cve_id}
            onChange={handleChange}
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
            placeholder="Ej: CVE-2024-12345"
          />
          <p className="text-xs text-gray-500 mt-1">
            Identificador oficial de la vulnerabilidad
          </p>
        </div>

        {/* Sistema Afectado */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            Sistema Afectado *
          </label>
          <input
            type="text"
            name="affected_system"
            value={formData.affected_system}
            onChange={handleChange}
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
            placeholder="Ej: Servidor Web Apache 2.4"
            required
          />
        </div>

        {/* CVSS Score */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            CVSS Score (0-10) *
          </label>
          <input
            type="number"
            name="cvss_score"
            value={formData.cvss_score}
            onChange={handleChange}
            step="0.1"
            min="0"
            max="10"
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
            required
          />
          <p className="text-xs text-gray-500 mt-1">
            Common Vulnerability Scoring System
          </p>
        </div>

        {/* Severidad (auto-calculada) */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            Severidad
          </label>
          <div className="w-full px-3 py-2 border border-gray-200 rounded-md bg-gray-50">
            <span className={`text-sm font-semibold ${getSeverityColor(formData.severity)}`}>
              {getSeverityText(formData.severity)}
            </span>
            <p className="text-xs text-gray-500 mt-1">
              Auto-calculada según CVSS Score
            </p>
          </div>
        </div>

        {/* Fecha de Descubrimiento */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            Fecha de Descubrimiento
          </label>
          <input
            type="date"
            name="discovery_date"
            value={formData.discovery_date}
            onChange={handleChange}
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
          />
        </div>

        {/* Estado */}
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            Estado *
          </label>
          <select
            name="status"
            value={formData.status}
            onChange={handleChange}
            className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
            required
          >
            <option value="open">Abierta</option>
            <option value="in_progress">En Progreso</option>
            <option value="patched">Parcheada</option>
            <option value="accepted">Aceptada</option>
          </select>
        </div>

        {/* Guía CVSS */}
        <div className="md:col-span-2 p-4 bg-blue-50 rounded-lg border border-blue-200">
          <h4 className="text-sm font-semibold text-blue-900 mb-2">Guía de CVSS Score</h4>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
            <div>
              <span className="font-semibold text-green-700">0.0 - 3.9:</span> Baja
            </div>
            <div>
              <span className="font-semibold text-yellow-700">4.0 - 6.9:</span> Media
            </div>
            <div>
              <span className="font-semibold text-orange-700">7.0 - 8.9:</span> Alta
            </div>
            <div>
              <span className="font-semibold text-red-700">9.0 - 10.0:</span> Crítica
            </div>
          </div>
        </div>
      </div>

      {/* Botones */}
      <div className="flex justify-end space-x-3 pt-4 border-t">
        <button
          type="button"
          onClick={onCancel}
          className="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500"
        >
          Cancelar
        </button>
        <button
          type="submit"
          className="px-4 py-2 text-sm font-medium text-white bg-purple-600 border border-transparent rounded-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500"
        >
          {vulnerability ? 'Actualizar' : 'Crear'} Vulnerabilidad
        </button>
      </div>
    </form>
  );
};

export default VulnerabilityForm;
